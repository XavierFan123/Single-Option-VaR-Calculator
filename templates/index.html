<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>期权持仓 VaR 计算器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 960px; }
        .card { margin-top: 20px; }
        .result-value { font-weight: bold; color: #0d6efd; }
        .loss-value { font-weight: bold; color: #dc3545; }
        .greeks-table td { padding: 0.5rem !important; }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="text-center">
            <h2>Unispark单一期权持仓 VaR 计算器</h2>
            <p class="lead">输入您的期权持仓信息，以使用蒙特卡洛模拟计算其风险价值 (Value at Risk)。</p>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">持仓参数</h5>
                <form action="/" method="post">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="ticker" class="form-label">股票代码 (Ticker)</label>
                            <input type="text" class="form-control" id="ticker" name="ticker" value="{{ defaults.ticker }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="expiry" class="form-label">到期日</label>
                            <input type="date" class="form-control" id="expiry" name="expiry" value="{{ defaults.expiry }}" required>
                        </div>
                        <div class="col-md-4">
                            <label for="strike" class="form-label">行权价</label>
                            <input type="number" step="any" class="form-control" id="strike" name="strike" value="{{ defaults.strike }}" required>
                        </div>
                        <div class="col-md-4">
                            <label for="position_size" class="form-label">头寸数量 (手数)</label>
                            <input type="number" class="form-control" id="position_size" name="position_size" value="{{ defaults.position_size }}" required>
                        </div>
                        <div class="col-md-4">
                            <label for="option_type" class="form-label">期权类型</label>
                            <select class="form-select" id="option_type" name="option_type">
                                <option value="call" {% if defaults.option_type == 'call' %}selected{% endif %}>看涨 (Call)</option>
                                <option value="put" {% if defaults.option_type == 'put' %}selected{% endif %}>看跌 (Put)</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-4 w-100">计算 VaR</button>
                </form>
            </div>
        </div>

        {% if results %}
            {% if results.success %}
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h4>计算结果: {{ results.ticker }} {{ results.strike }} {{ results.option_type }} @ {{ results.expiry }}</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>关键风险指标 (1天)</h5>
                            <ul class="list-group">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    95% VaR (风险价值)
                                    <span class="loss-value">${{ "{:,.2f}".format(-results.var_95) }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    99% VaR (风险价值)
                                    <span class="loss-value">${{ "{:,.2f}".format(-results.var_99) }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    95% CVaR (条件风险价值)
                                    <span class="loss-value">${{ "{:,.2f}".format(-results.cvar_95) }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    99% CVaR (条件风险价值)
                                    <span class="loss-value">${{ "{:,.2f}".format(-results.cvar_99) }}</span>
                                </li>
                            </ul>
                            <h5 class="mt-4">市场与估值</h5>
                            <ul class="list-group">
                                <li class="list-group-item d-flex justify-content-between align-items-center">当前股价 <span class="result-value">${{ results.current_price }}</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">总持仓价值 <span class="result-value">${{ "{:,.2f}".format(results.total_position_value) }}</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">隐含波动率 <span class="result-value">{{ results.implied_volatility }}%</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">无风险利率 <span class="result-value">{{ results.risk_free_rate }}%</span></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5>期权希腊字母 (Greeks)</h5>
                            <p class="text-muted small">所有指标均为总头寸指标。</p>
                            <table class="table table-sm table-bordered greeks-table">
                                <tbody>
                                    <tr><td><strong>Delta</strong> (方向风险)</td><td class="text-end result-value">{{ "{:,.2f}".format(results.greeks.delta * results.position_size * 100) }}</td></tr>
                                    <tr><td><strong>Gamma</strong> (Delta变化率)</td><td class="text-end result-value">{{ "{:,.4f}".format(results.greeks.gamma * results.position_size * 100) }}</td></tr>
                                    <tr><td><strong>Theta</strong> (时间衰减 /天)</td><td class="text-end loss-value">${{ "{:,.2f}".format(results.greeks.theta * results.position_size * 100) }}</td></tr>
                                    <tr><td><strong>Vega</strong> (波动率风险 /1%)</td><td class="text-end result-value">${{ "{:,.2f}".format(results.greeks.vega * results.position_size * 100) }}</td></tr>
                                    <tr><td><strong>Rho</strong> (利率风险 /1%)</td><td class="text-end result-value">${{ "{:,.2f}".format(results.greeks.rho * results.position_size * 100) }}</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <hr>
                    <div class="mt-3">
                         <h5>1日盈亏分布图 (P&L Distribution)</h5>
                         <img src="data:image/png;base64,{{ results.chart_url }}" class="img-fluid" alt="P&L Distribution Chart">
                    </div>
                </div>
            </div>
            {% elif results.success == False %}
            <div class="alert alert-danger mt-4" role="alert">
                <strong>计算失败:</strong> {{ results.error }}
            </div>
            {% endif %}
        {% endif %}

        <footer class="text-center text-muted pt-4">
            <p>&copy; 2025 VaR Calculator - 基于蒙特卡洛模拟</p>
        </footer>
    </div>
</body>
</html>
